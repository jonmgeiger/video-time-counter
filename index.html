<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Frame Analyzer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 900px;
        }
        .video-container {
            position: relative;
            background-color: #1f2937; /* Dark background for video area */
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #video-player {
            width: 100%;
            height: auto;
            display: block;
            /* The 'controls' attribute is kept in HTML for fallback but custom UI is preferred */
        }
        /* Custom progress bar styling for better visual integration */
        #video-load-progress::-webkit-progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
        }
        #video-load-progress::-webkit-progress-value {
            background-color: #10b981; /* Tailwind green-500 */
            border-radius: 9999px;
            transition: width 0.3s ease;
        }
        #video-load-progress {
            appearance: none;
            -webkit-appearance: none;
            border: none;
        }
        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Video Frame Counter</h1>
            <p class="mt-2 text-lg text-gray-500">Analyze video playback with frame-accurate timecodes.</p>
        </header>

        <main class="space-y-6">

            <!-- Control and Input Panel -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Settings & Upload</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <!-- File Input -->
                    <div class="space-y-2">
                        <label for="video-file-input" class="block text-sm font-medium text-gray-700">Select Video File</label>
                        <input type="file" id="video-file-input" accept="video/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    </div>

                    <!-- FPS Input -->
                    <div class="space-y-2">
                        <label for="fps-input" class="block text-sm font-medium text-gray-700">Frames Per Second (FPS) <span class="text-red-500">*</span></label>
                        <input type="number" id="fps-input" value="24" placeholder="e.g., 24, 25, 30, 60" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2.5 border">
                        <p class="text-xs text-gray-500 italic">Frame calculation relies on this input, as video metadata is unreliable in the browser.</p>
                    </div>
                </div>
            </div>
            
            <!-- Playback Controls -->
            <div id="controls-panel" class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 flex flex-col items-center">
                <div class="flex justify-center space-x-4 w-full">
                    <button id="play-button" 
                            class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150 disabled:opacity-50 flex items-center"
                            disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Play
                    </button>
                    
                    <button id="pause-button" 
                            class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150 disabled:opacity-50 flex items-center"
                            disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Pause
                    </button>
                    
                    <button id="step-backward-button" 
                            class="px-4 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150 disabled:opacity-50"
                            disabled>
                        &lt;&lt; Frame
                    </button>
                    
                    <button id="step-forward-button" 
                            class="px-4 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150 disabled:opacity-50">
                        Frame &gt;&gt;
                    </button>
                </div>

                <!-- Progress Bar Container (Hidden until loading starts) -->
                <div class="mt-4 w-full h-2 bg-gray-200 rounded-full hidden" id="progress-container">
                    <progress id="video-load-progress" class="w-full h-full rounded-full" max="100" value="0"></progress>
                </div>
            </div>

            <!-- Video Player & Display -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Video Display -->
                <div class="video-container lg:col-span-2">
                    <video id="video-player" controls preload="metadata" muted></video>
                    <!-- Placeholder text for when no video is loaded -->
                    <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-gray-800 transition-opacity duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.55 3.23a1 1 0 010 1.54L15 18V10zm-5 0l4.55 3.23a1 1 0 010 1.54L10 18V10zm-5 0l4.55 3.23a1 1 0 010 1.54L5 18V10z" />
                        </svg>
                        <p id="placeholder-text" class="text-lg">Upload a video to begin analysis.</p>
                    </div>
                </div>

                <!-- Counters Display -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col justify-center space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-2">Current Position</h2>

                    <!-- Framerate Display -->
                    <div class="border-b pb-4">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Configured Framerate</p>
                        <p id="display-fps" class="text-3xl font-bold text-gray-900 mt-1">-- FPS</p>
                    </div>

                    <!-- Seconds Counter -->
                    <div class="border-b pb-4">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Seconds Counter (0.01s)</p>
                        <p id="time-counter" class="text-5xl font-extrabold text-blue-600 mt-1 tabular-nums">0.00s</p>
                    </div>

                    <!-- Frame Counter -->
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Frame Count</p>
                        <p id="frame-counter" class="text-5xl font-extrabold text-blue-600 mt-1 tabular-nums">0</p>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        const videoInput = document.getElementById('video-file-input');
        const videoPlayer = document.getElementById('video-player');
        const fpsInput = document.getElementById('fps-input');
        const timeCounter = document.getElementById('time-counter');
        const frameCounter = document.getElementById('frame-counter');
        const displayFps = document.getElementById('display-fps');
        const videoPlaceholder = document.getElementById('video-placeholder');
        
        // New element reference for the placeholder text
        const placeholderText = document.getElementById('placeholder-text');

        // Custom Controls
        const playButton = document.getElementById('play-button');
        const pauseButton = document.getElementById('pause-button');
        const stepForwardButton = document.getElementById('step-forward-button');
        const stepBackwardButton = document.getElementById('step-backward-button');
        
        // Progress Bar Elements
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('video-load-progress');

        let animationFrameId = null;
        let progressIntervalId = null; // New interval ID for progress check
        let currentFPS = parseFloat(fpsInput.value) || 24;
        
        // Detailed error messages for MediaError codes
        const mediaErrorMessages = {
            1: 'MEDIA_ERR_ABORTED: Video loading was interrupted (e.g., user stopped loading).',
            2: 'MEDIA_ERR_NETWORK: A network error occurred while fetching the video.',
            3: 'MEDIA_ERR_DECODE: The video file is corrupted or its format is not supported by your browser.',
            4: 'MEDIA_ERR_SRC_NOT_SUPPORTED: The video format is not suitable for your browser (try a different format like MP4 or WebM).',
            0: 'UNKNOWN_ERROR: An unknown media error occurred.'
        };


        // --- Helper Functions ---

        /**
         * Enables or disables all playback control buttons.
         * @param {boolean} enable - True to enable, false to disable.
         */
        function toggleControls(enable) {
            playButton.disabled = !enable;
            pauseButton.disabled = !enable;
            stepForwardButton.disabled = !enable;
            stepBackwardButton.disabled = !enable;
        }

        /**
         * Sets the Play button to a loading state.
         */
        function setLoadingState() {
            playButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Loading...`;
            playButton.classList.add('bg-gray-500', 'cursor-wait');
            playButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'cursor-pointer');
        }

        /**
         * Resets the Play button to the active state.
         */
        function setActiveState() {
            playButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg> Play`;
            playButton.classList.remove('bg-gray-500', 'cursor-wait');
            playButton.classList.add('bg-green-500', 'hover:bg-green-600', 'cursor-pointer');
        }

        /**
         * Converts raw seconds into a formatted time string (0.00s)
         */
        function formatTime(seconds) {
            // Round to the nearest hundredth
            const formattedTime = (Math.round(seconds * 100) / 100).toFixed(2);
            return `${formattedTime}s`;
        }

        function calculateFrame(seconds, fps) {
            if (fps <= 0) return 0;
            return Math.floor(seconds * fps);
        }

        function updateCounters() {
            const currentTime = videoPlayer.currentTime;

            // 1. Update Seconds Counter (to hundredths)
            timeCounter.textContent = formatTime(currentTime);

            // 2. Update Frame Counter
            const frame = calculateFrame(currentTime, currentFPS);
            frameCounter.textContent = frame.toString();

            // 3. Loop if playing
            if (!videoPlayer.paused) {
                animationFrameId = requestAnimationFrame(updateCounters);
            }
        }
        
        /**
         * Checks and updates the video loading progress bar.
         */
        function updateProgress() {
            if (videoPlayer.readyState > 0 && videoPlayer.duration > 0) {
                const duration = videoPlayer.duration;
                let bufferedEnd = 0;
                
                // Find the end of the first buffered time range
                if (videoPlayer.buffered.length > 0) {
                    bufferedEnd = videoPlayer.buffered.end(0);
                }

                const progressPercent = (bufferedEnd / duration) * 100;
                progressBar.value = progressPercent;
            }
        }

        /**
         * Attempts to play the video and update control state.
         */
        function handlePlay() {
            if (videoPlayer.src && !playButton.disabled) {
                videoPlayer.play().catch(e => console.error("Video Playback Error:", e));
            }
        }
        
        /**
         * Pauses the video and updates control state.
         */
        function handlePause() {
            videoPlayer.pause();
        }
        
        /**
         * Steps the video forward or backward by exactly one frame.
         */
        function stepFrame(direction) {
            if (currentFPS > 0 && videoPlayer.duration) {
                videoPlayer.pause(); 
                const frameDuration = 1 / currentFPS;
                let newTime = videoPlayer.currentTime + (direction * frameDuration);

                // Clamp time to video boundaries
                newTime = Math.max(0, Math.min(videoPlayer.duration, newTime));
                
                // Adjust time to be frame-accurate
                const nearestFrame = Math.round(newTime / frameDuration);
                const snappedTime = nearestFrame * frameDuration;

                videoPlayer.currentTime = snappedTime;
            }
        }


        // --- Event Handlers ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Clear old state
                if (videoPlayer.src) URL.revokeObjectURL(videoPlayer.src);
                if (progressIntervalId) clearInterval(progressIntervalId);

                const fileURL = URL.createObjectURL(file);
                videoPlayer.src = fileURL;

                // Reset placeholder text/color
                placeholderText.textContent = 'Uploading and buffering video...';
                placeholderText.classList.remove('text-red-400');
                placeholderText.classList.add('text-gray-400');
                videoPlaceholder.style.opacity = 1; // Ensure placeholder is visible during loading


                // Set loading state and start progress monitor
                toggleControls(false);
                setLoadingState();
                progressContainer.classList.remove('hidden'); // Show progress bar
                progressBar.value = 0;
                
                // Start checking progress every 100ms
                progressIntervalId = setInterval(updateProgress, 100);

                // Hide video player temporarily
                videoPlayer.style.opacity = 0; 
            } else {
                toggleControls(false);
                progressContainer.classList.add('hidden');
                // Reset placeholder text
                placeholderText.textContent = 'Upload a video to begin analysis.';
                placeholderText.classList.remove('text-red-400');
                placeholderText.classList.add('text-gray-400');
            }
        }

        function handleFPSChange() {
            const newFPS = parseFloat(fpsInput.value);
            if (newFPS > 0) {
                currentFPS = newFPS;
                displayFps.textContent = `${currentFPS} FPS`;
                updateCounters();
            } else {
                displayFps.textContent = '-- FPS';
                currentFPS = 0;
            }
        }

        // --- Video Event Listeners ---

        videoPlayer.addEventListener('loadedmetadata', () => {
            // Stop progress monitoring
            if (progressIntervalId) {
                clearInterval(progressIntervalId);
                progressIntervalId = null;
            }
            progressContainer.classList.add('hidden'); // Hide progress bar

            // Ensure the video is visible and placeholder is hidden
            videoPlayer.style.opacity = 1;
            videoPlaceholder.style.opacity = 0;

            // Update FPS display and enable controls
            handleFPSChange();
            setActiveState();
            toggleControls(true); 
        });
        
        // Error handling in case the video cannot be loaded
        videoPlayer.addEventListener('error', (e) => {
            if (progressIntervalId) {
                clearInterval(progressIntervalId);
                progressIntervalId = null;
            }
            progressContainer.classList.add('hidden');
            
            // Revert to play button, but keep disabled
            setActiveState();
            toggleControls(false);
            
            const error = videoPlayer.error;
            const errorCode = error ? error.code : 0;
            const errorMessage = mediaErrorMessages[errorCode] || mediaErrorMessages[0];

            // FIX: Removed the second 'error' argument to prevent the trailing '{}' in the console log.
            // 1. Log detailed error to console
            console.error(`Video Error (Code ${errorCode}): ${errorMessage}`);

            // 2. Display error message in the UI
            placeholderText.textContent = `Error Loading Video (Code ${errorCode}): ${errorMessage}`;
            placeholderText.classList.remove('text-gray-400');
            placeholderText.classList.add('text-red-400');
            videoPlaceholder.style.opacity = 1; // Make sure the placeholder is visible

            // Ensure video remains hidden or reset
            videoPlayer.style.opacity = 0;
        });


        // Start the continuous update loop when playback begins
        videoPlayer.addEventListener('play', () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(updateCounters);
            playButton.disabled = true;
            pauseButton.disabled = false;
        });

        // Stop the continuous update loop when playback stops or is paused
        videoPlayer.addEventListener('pause', () => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            updateCounters();
            playButton.disabled = false;
            pauseButton.disabled = true;
        });

        // Also update the counter when the user seeks (scrubs the timeline)
        videoPlayer.addEventListener('seeked', updateCounters);

        // If the video ends, stop the loop
        videoPlayer.addEventListener('ended', () => {
             if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            updateCounters();
        });


        // --- Initialization ---

        // Attach main listeners
        videoInput.addEventListener('change', handleFileSelect);
        fpsInput.addEventListener('input', handleFPSChange);
        
        // Attach custom control listeners
        playButton.addEventListener('click', handlePlay);
        pauseButton.addEventListener('click', handlePause);
        stepForwardButton.addEventListener('click', () => stepFrame(1));
        stepBackwardButton.addEventListener('click', () => stepFrame(-1));
        
        // Keyboard shortcuts for frame stepping
        document.addEventListener('keydown', (e) => {
            if (!videoPlayer.src) return; 

            if (e.key === 'ArrowRight' && !stepForwardButton.disabled) {
                e.preventDefault();
                stepFrame(1);
            } else if (e.key === 'ArrowLeft' && !stepBackwardButton.disabled) {
                e.preventDefault();
                stepFrame(-1);
            } else if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                if (videoPlayer.paused) {
                    handlePlay();
                } else {
                    handlePause();
                }
            }
        });


        // Initial setup
        displayFps.textContent = `${currentFPS} FPS`;
        videoPlayer.style.opacity = 0; 
        toggleControls(false); 
    </script>
</body>
</html>
